apiVersion: v1
kind: Pod
metadata:
  name: centos9
  labels:
    app: centos9
  namespace: gfs2-storage
spec:
  securityContext:
    runAsNonRoot: true
    seccompProfile:
      type: RuntimeDefault
  containers:
    - name: centos9
      image: 'quay.io/centos/centos:stream9'
      command: [ "/bin/bash", "-c", "--" ]
      args: [ "while true; do sleep 30; done;" ]
      ports:
        - containerPort: 8080
      securityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL



spec:
  nodeSelector:
    node-role.kubernetes.io/worker: ''
  output:
    to:
      kind: ImageStreamTag
      name: 'simple-kmod-driver-container:demo'
  resources: {}
  successfulBuildsHistoryLimit: 5
  failedBuildsHistoryLimit: 5
  strategy:
    type: Docker
    dockerStrategy:
      buildArgs:
        - name: KMODVER
          value: DEMO
        - name: DTK
          value: >-
            quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:34864ccd2f4b6e385705a730864c04a40908e57acede44457a783d739e377cae
        - name: KVER
          value: 4.18.0-372.26.1.el8_6.x86_64
  postCommit: {}
  source:
    type: Dockerfile
    dockerfile: >
      ARG DTK

      FROM ${DTK} as builder


      ARG KVER


      WORKDIR /build/


      RUN git clone https://github.com/openshift-psap/simple-kmod.git


      WORKDIR /build/simple-kmod


      RUN make all install KVER=${KVER}


      FROM registry.redhat.io/ubi8/ubi-minimal


      ARG KVER


      # Required for installing `modprobe`

      RUN microdnf install kmod


      COPY --from=builder /lib/modules/${KVER}/simple-kmod.ko
      /lib/modules/${KVER}/

      COPY --from=builder /lib/modules/${KVER}/simple-procfs-kmod.ko
      /lib/modules/${KVER}/

      RUN depmod ${KVER}
  triggers:
    - type: ConfigChange
  runPolicy: Serial
status:
  lastVersion: 2
